<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:url" content="https://canvas.resurnate.com/index.html">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Resurnate Canvas Wizard">
  <meta property="og:description" content="The Canvas tool enables a content provider to create a comic strip for Resurnate.com.">
  <title>Canvas Wizard</title>
  <link rel="stylesheet" href="/css/main.css">
  <script type="text/javascript">

    let nextPanelId = 1;
    let peekPanelId = '';

    function _initPage() {
      peekPanelId = '';
      let sectionsElement = document.getElementById('panel-sections');
      // Attribution
      let sectionElement = _initAttributionSection();
      sectionsElement.appendChild(sectionElement);
      // Panels
      for (let i = 0; i < 4; i++) {
        sectionElement = _initPanelSection(i === 0);
        sectionsElement.appendChild(sectionElement);
        nextPanelId += 1;
      }
    }

    function _initAttributionSection() {
      // Create section
      let sectionElement = document.createElement('section');
      sectionElement.id = 'attribution-section';
      sectionElement.className = 'wizard-section';
      // Create section header
      let headerElement = document.createElement('div');
      headerElement.id = 'attribution-header';
      headerElement.className = 'wizard-header';
      sectionElement.appendChild(headerElement);
      _initAttributionHeader(headerElement);
      // Create section content
      let contentElement = document.createElement('div');
      contentElement.id = 'attribution-content';
      sectionElement.appendChild(contentElement);
      _initAttributionContent(contentElement);
      return sectionElement;
    }

    function _initAttributionHeader(headerElement) {
      // Toggle
      let toggleElement = document.createElement('a');
      toggleElement.id = 'attribution-toggle';
      toggleElement.href = 'javascript:';
      toggleElement.text = _toggleAttributionText(true);
      let onclick = '_toggleAttribution()';
      toggleElement.setAttribute('onclick',onclick);
      headerElement.appendChild(toggleElement);
    }

    function _initAttributionContent(contentElement) {
      // Layout
      let layoutElement = document.createElement('div');
      layoutElement.id = 'attribution-layout';
      layoutElement.className = 'wizard-attribution';
      contentElement.appendChild(layoutElement);
      // Title
      let divElement = document.createElement('div');
      divElement.className = 'wizard-attribution-group';
      layoutElement.appendChild(divElement);
      let labelElement = document.createElement('label');
      labelElement.innerHTML = 'Strip title';
      labelElement.htmlFor = 'attribution-title';
      divElement.appendChild(labelElement);
      let titleElement = document.createElement('input');
      labelElement.id = 'attribution-title';
      titleElement.type = 'text';
      titleElement.name = 'attribution-title';
      titleElement.value = 'Something catchy';
      divElement.appendChild(titleElement);
      // Author
      divElement = document.createElement('div');
      divElement.className = 'wizard-attribution-group';
      layoutElement.appendChild(divElement);
      labelElement = document.createElement('label');
      labelElement.innerHTML = 'Strip author';
      labelElement.htmlFor = 'attribution-author';
      divElement.appendChild(labelElement);
      let authorElement = document.createElement('input');
      authorElement.id = 'author-title';
      authorElement.type = 'text';
      authorElement.name = 'author-title';
      authorElement.value = 'Pen name';
      divElement.appendChild(authorElement);
    }

    function _toggleAttribution() {
      // Content
      let elementId = 'attribution-content';
      let open = toggleElement(elementId);
      // Header
      let element = document.getElementById('attribution-toggle');
      element.text = _toggleAttributionText(open);
    }

    function _toggleAttributionText(open) {
      let charCode = open ? 0x21F1 : 0x21F2;
      let direction = String.fromCharCode(charCode);
      return direction + ' Attribution';
    }

    function _initPanelSection(panelOpen) {
      let panelId = 'p' + nextPanelId;
      // Create section
      let sectionElement = document.createElement('section');
      sectionElement.id = panelId + '-section';
      sectionElement.className = 'wizard-section';
      // Create section header
      let headerElement = document.createElement('div');
      headerElement.id = panelId + '-header';
      headerElement.className = 'wizard-header';
      sectionElement.appendChild(headerElement);
      _initPanelHeader(panelId,panelOpen,headerElement);
      // Create section content
      let contentElement = document.createElement('div');
      contentElement.id = panelId + '-content';
      if (!panelOpen) {
        contentElement.style = 'display: none';
      }
      sectionElement.appendChild(contentElement);
      _initPanelContent(panelId,contentElement);
      return sectionElement;
    }

    function _initPanelHeader(panelId,panelOpen,headerElement) {
      // Toggle
      let toggleElement = document.createElement('a');
      toggleElement.id = panelId + '-toggle';
      toggleElement.href = 'javascript:';
      toggleElement.text = _togglePanelText(panelOpen);
      let onclick = '_togglePanel("'+panelId+'")';
      toggleElement.setAttribute('onclick',onclick);
      headerElement.appendChild(toggleElement);
      // Div
      let actionElement = document.createElement('a');
      actionElement.className = 'wizard-header-action';
      headerElement.appendChild(actionElement);
      // Add
      let addElement = document.createElement('a');
      addElement.href = 'javascript:';
      addElement.text = String.fromCharCode(0x002B);
      onclick = '_addPanel("'+panelId+'")';
      addElement.setAttribute('onclick',onclick);
      actionElement.appendChild(addElement);
      // Remove
      let removeElement = document.createElement('a');
      removeElement.href = 'javascript:';
      removeElement.text = String.fromCharCode(0x00D7);
      onclick = '_removePanel("'+panelId+'")';
      removeElement.setAttribute('onclick',onclick);
      actionElement.appendChild(removeElement);
    }

    function _initPanelContent(panelId,contentElement) {
      let panelElement = document.createElement('div');
      panelElement.id = panelId + '-panel';
      panelElement.className = 'wizard-panel';
      contentElement.appendChild(panelElement);
      _initPanelAction(panelId,panelElement);
      _initPanelInputBubble(panelId,panelElement);
      _initPanelInputCaption(panelId,panelElement);
      _initPanelPeek(panelId,panelElement);
      _initPanelJson(panelId,panelElement);
    }

    function _initPanelAction(panelId,panelElement) {
      let actionElement = document.createElement('div');
      actionElement.id = panelId + '-action';
      actionElement.className = 'wizard-action';
      panelElement.appendChild(actionElement);
      // Peek
      let peekElement = document.createElement('input');
      peekElement.type = 'button';
      peekElement.value = 'PEEK';
      peekElement.className = 'button';
      let onclick = '_peekInit("'+panelId+'")';
      peekElement.setAttribute('onclick',onclick);
      actionElement.appendChild(peekElement);
      // JSON
      let jsonElement = document.createElement('input');
      jsonElement.type = 'button';
      jsonElement.value = 'JSON';
      jsonElement.className = 'button';
      onclick = '_peekJson("'+panelId+'")';
      jsonElement.setAttribute('onclick',onclick);
      actionElement.appendChild(jsonElement);
      // Hide
      let hideElement = document.createElement('input');
      hideElement.type = 'button';
      hideElement.value = 'HIDE';
      hideElement.className = 'button';
      onclick = '_peekHide("'+panelId+'")';
      hideElement.setAttribute('onclick',onclick);
      actionElement.appendChild(hideElement);
    }

    function _initPanelInputBubble(panelId,panelElement) {
      let inputElement = document.createElement('div');
      inputElement.id = panelId + '-bubble';
      inputElement.className = 'wizard-bubble';
      panelElement.appendChild(inputElement);
      _initPanelInputBubbleImage(panelId,inputElement);
      _initPanelInputBubbleText(panelId,inputElement);
    }

    function _initPanelInputCaption(panelId,panelElement) {
      let inputElement = document.createElement('div');
      inputElement.id = panelId + '-caption';
      inputElement.className = 'wizard-caption';
      panelElement.appendChild(inputElement);
      _initPanelInputCaptionText(panelId,inputElement);
    }

    function _initPanelInputBubbleImage(panelId,inputElement) {
      let headerElement = document.createElement('h3');
      headerElement.innerHTML = 'Bubble Image';
      inputElement.appendChild(headerElement);
      let labelFor = panelId+'b';
      let labelElement = document.createElement('label');
      labelElement.innerHTML = 'Choose: &nbsp; ';
      labelElement.htmlFor = labelFor;
      inputElement.appendChild(labelElement);
      let selectElement = document.createElement('select');
      selectElement.id = labelFor;
      selectElement.name = labelFor;
      inputElement.appendChild(selectElement);
      for (let label of BUBBLE_LABELS) {
        let optionElement = document.createElement('option');
        optionElement.value = label;
        optionElement.text = label;
        selectElement.appendChild(optionElement);
      }
    }

    function _initPanelInputBubbleText(panelId,inputElement) {
      let headerElement = document.createElement('h3');
      headerElement.innerHTML = 'Bubble Text';
      inputElement.appendChild(headerElement);
      for (let i = 1; i <= 3; i++) {
        let labelFor = panelId+'b'+i;
        let labelElement = document.createElement('label');
        let labelHtml = i;
        if (i === 1) {
          labelHtml = labelHtml+' (Top)';
        } else if (i === 3) {
          labelHtml = labelHtml+' (Bottom)';
        } else {
          labelHtml = labelHtml+' (Between)';
        }
        labelElement.innerHTML = labelHtml;
        labelElement.htmlFor = labelFor;
        inputElement.appendChild(labelElement);
        let textareaElement = document.createElement('textarea');
        textareaElement.id = labelFor;
        textareaElement.name = labelFor;
        textareaElement.value = i;
        textareaElement.rows = 3;
        inputElement.appendChild(textareaElement);
      }
    }

    function _initPanelInputCaptionText(panelId,inputElement) {
      let headerElement = document.createElement('h3');
      headerElement.innerHTML = 'Caption Text';
      inputElement.appendChild(headerElement);
      for (let i = 1; i <= 4; i++) {
        let labelFor = panelId+'c'+i;
        let labelElement = document.createElement('label');
        let labelHtml = i;
        let textValue = i;
        if (i === 1) {
          labelHtml = labelHtml+' (Upper Left)';
          textValue = 'Where';
        } else if (i === 2) {
          labelHtml = labelHtml+' (Upper Right)';
          textValue = 'When';
        } else if (i === 3) {
          labelHtml = labelHtml+' (Lower Left)';
          textValue = 'From Who\n(Emotion)';
        } else {
          labelHtml = labelHtml+' (Lower Right)';
          textValue = 'To Who\n(Emotion)';
        }
        labelElement.innerHTML = labelHtml;
        labelElement.htmlFor = labelFor;
        inputElement.appendChild(labelElement);
        let textareaElement = document.createElement('textarea');
        textareaElement.id = labelFor;
        textareaElement.name = labelFor;
        textareaElement.value = textValue;
        textareaElement.rows = 3;
        inputElement.appendChild(textareaElement);
      }
    }

    function _initPanelPeek(panelId,panelElement) {
      let peekElement = document.createElement('div');
      peekElement.id = panelId + '-peek';
      peekElement.className = 'wizard-peek';
      panelElement.appendChild(peekElement);
    }

    function _initPanelJson(panelId,panelElement) {
      let jsonElement = document.createElement('div');
      jsonElement.id = panelId + '-json';
      jsonElement.className = 'wizard-json';
      panelElement.appendChild(jsonElement);
    }

    function _togglePanel(panelId) {
      // Content
      let elementId = panelId+'-content';
      let open = toggleElement(elementId);
      // Header
      let element = document.getElementById(panelId+'-toggle');
      element.text = _togglePanelText(open);
    }

    function _togglePanelText(open) {
      let charCode = open ? 0x21F1 : 0x21F2;
      let direction = String.fromCharCode(charCode);
      return direction + ' Panel';
    }

    function _addPanel(panelId) {
      let sectionsElement = document.getElementById('panel-sections');
      // Find next sibling
      let sectionId = panelId + '-section';
      let siblingElement;
      let found = false;
      for (let childElement of sectionsElement.childNodes) {
        if (childElement.id !== undefined) {
          if (childElement.id === sectionId) {
            found = true;
          } else if (found) {
            siblingElement = childElement;
            break;
          }
        }
      }
      // Insert before sibling
      let sectionElement = _initPanelSection(true);
      if (siblingElement === undefined) {
        // Last panel section
        sectionsElement.appendChild(sectionElement);
      } else {
        sectionsElement.insertBefore(sectionElement, siblingElement);
      }
      nextPanelId += 1;
    }

    function _removePanel(panelId) {
      let sectionsElement = document.getElementById('panel-sections');
      // Find next sibling
      let sectionId = panelId + '-section';
      for (let childElement of sectionsElement.childNodes) {
        if (childElement.id !== undefined) {
          if (childElement.id === sectionId) {
            childElement.remove();
            break;
          }
        }
      }
    }

    function _peekInit(panelId) {
      let imageElement = panelId+'b';
      let imageLabel = document.getElementById(imageElement).value;
      let imageLabels = [ imageLabel ];
      let imageURLs = prepareImages(window.location.origin,imageLabels);
      peekPanelId = panelId;
      loadImages(imageURLs,_peekAtPanel,_loadError);
    }

    function _peekJson(panelId) {
      let peekElement = document.getElementById(panelId+'-peek');
      peekElement.style.display = 'none';
      let jsonElement = document.getElementById(panelId+'-json');
      jsonElement.style.display = 'flex';
    }

    function _peekHide(panelId) {
      let peekElement = document.getElementById(panelId+'-peek');
      peekElement.style.display = 'none';
      let jsonElement = document.getElementById(panelId+'-json');
      jsonElement.style.display = 'none';
    }

    function _peekAtPanel(images) {
      // Remove previous peek
      let peekElement = document.getElementById(peekPanelId+'-peek');
      let canvasElement =  document.getElementById(peekPanelId+'canvas');
      if (canvasElement !== null) {
        peekElement.removeChild(canvasElement);
      }
      // Remove previous JSON
      let jsonElement = document.getElementById(peekPanelId+'-json');
      let preElement =  document.getElementById(peekPanelId+'pre');
      if (preElement !== null) {
        jsonElement.removeChild(preElement);
      }
      _peekParsePrepareAndDraw(images);
    }

    function _loadError(url) {
      alert('Failed to load one or more images: ' + url);
      peekPanelId = '';
    }

    function _peekParsePrepareAndDraw(images) {
      let pi = _peekParse(peekPanelId);
      let input = {
        version: '1',
        id: 'N/A',
        title: 'N/A',
        author: 'N/A',
        panels: [ pi ]
      };
      let prepared = _canvasPrepare(input,images);
      _canvasDraw(peekPanelId,prepared);
    }

    function _peekParse(panelId) {
      // Parse image
      let ebl = panelId+'b';
      let bl = document.getElementById(ebl).value;
      let bc = parsePanelBubbleCount(bl);
      // Parse bubbles
      let bs = [];
      for (let i = 0; i < bc; i++) {
        let bp = i + 1;
        let ebts = ebl+bp;
        let bts = document.getElementById(ebts).value;
        let b = {
          position: bp,
          text: parsePanelText(bts)
        };
        bs.push(b);
      }
      // Parse captions
      let ecl = panelId+'c';
      let cs = [];
      for (let i = 0; i < 4; i++) {
        let cp = i + 1;
        let ects = ecl+cp;
        let cts = document.getElementById(ects).value;
        let c = {
          position: cp,
          text: parsePanelText(cts)
        };
        cs.push(c);
      }
      // Return
      return {
        image: bl,
        bubbles: bs,
        captions: cs
      };
    }

    function _canvasPrepare(input,images) {
      let canvas = document.createElement('canvas');
      let context = canvas.getContext('2d');
      let filtered = prepareCanvas(context,input,images);
      let pre = document.createElement('pre');
      pre.innerText = JSON.stringify(input.panels[0],null,2);
      return {
        canvas   : canvas,
        filtered : filtered,
        pre      : pre
      };
    }

    function _canvasDraw(panelId,prepared) {
      // Peek
      prepared.canvas.id     = panelId+'canvas';
      prepared.canvas.width  = prepared.filtered.w;
      prepared.canvas.height = prepared.filtered.h;
      prepared.canvas.style = "width: 100%";
      let peek = document.getElementById(panelId+'-peek');
      peek.style.display = 'flex';
      peek.appendChild(prepared.canvas);
      drawCanvas(prepared.filtered,false);
      // JSON
      prepared.pre.id = panelId+'pre';
      let json = document.getElementById(panelId+'-json');
      json.style.display = 'none';
      json.appendChild(prepared.pre);
    }

  </script>
</head>
<body onload="_initPage();">

<!-- Header -->
<div id="header">
  <h1 class="title"><a href="/">Resurnate</a></h1>
</div>

<!-- Menu -->
<div id="menu">
  <a class="item" href="/">Tool</a>
  <span style="color: white">&#10192;</span>
  <a class="item" href="/help.html">Help</a>
</div>

<!-- Title -->
<h1>Canvas Wizard</h1>
<ul>
  <li>This tool enables a content provider to create a comic strip for <a href="https://resurnate.com" target="_blank">Resurnate.com</a>.</li>
</ul>

<!-- Panel Sections -->
<div class="wizard-sections" id="panel-sections">
</div>

<!-- Footer -->
<br>
<p class="line">&nbsp;</p>
<div id="footer">
  <p><a href="/privacy.html">Privacy</a></p>
  <p class="copyright">&#169; 2023 resurnate.com</p>
</div>

<script type="text/javascript" src="/js/main.js"></script>
<script type="text/javascript" src="/js/canvas.js"></script>
</body>
</html>