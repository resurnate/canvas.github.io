<!DOCTYPE html>
<html>
<body>

<h1>HTML5 Canvas</h1>

<canvas id="canvas"></canvas>

<script>

  const CANVAS_ELEMENT = document.getElementById("canvas");
  const CANVAS_ROWS = 2;
  const PANEL_PADDING = 10;
  const PANEL_WIDTH = 630;
  const PANEL_HEIGHT = 630;
  const CAPTION_WIDTH = (PANEL_WIDTH - PANEL_PADDING) / 2;
  const CAPTION_HEIGHT = 90;
// XXX: This should be read in from a v1 file appropriately!
  const BUBBLE_OFFSETS = [
    {
      l : "speech1",
      i : { w : 0, h : -150, x : 0, y : 100 },
      t : [
        { x : 0, y : -15 }
      ]
    },
    {
      l : "speech3",
      i : { w : -20, h : -180, x : 12, y : 100 },
      t : [
        { x : 135, y : -110 },
        { x : -140, y : -49 },
        { x : -8, y : 110 }
      ]
    },
    {
      l : "thought1",
      i : { w : -25, h : -120, x : 10, y : 110 },
      t : [
        { x : 0, y : -40 }
      ]
    },
    {
      l : "burst1",
      i : { w : 20, h : -140, x : -10, y : 70 },
      t : [
        { x : 0, y : 10 }
      ]
    }
  ];

  const json =
`{
  "version": "1",
  "id": "2023-001",
  "copyright": "2023 resurnate.com",
  "title": "Experience, Meet Team",
  "author": "Quigley",
  "panels": [
    {
      "image": "thought1",
      "captions": [
        {
          "position": 3,
          "text": [
            "Me",
            "(Motivated)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "Just going to pump",
            "out some boilerplate",
            "crap I've done a thousand",
            "times before..."
          ]
        }
      ]
    },
    {
      "image": "thought1",
      "captions": [
        {
          "position": 1,
          "text": [
            "20 minutes later"
          ]
        },
        {
          "position": 3,
          "text": [
            "Me",
            "(Chuffed)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "Awesome! Moving on."
          ]
        }
      ]
    },
    {
      "image": "speech1",
      "captions": [
        {
          "position": 1,
          "text": [
            "During the next",
            "standup..."
          ]
        },
        {
          "position": 3,
          "text": [
            "Me to Team",
            "(Casually)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "Oh by the way, I knocked",
            "out some of the usual",
            "stuff in the project",
            "yesterday."
          ]
        }
      ]
    },
    {
      "image": "speech3",
      "captions": [
        {
          "position": 3,
          "text": [
            "Team",
            "(Swarm of hornets)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "Do we even",
            "need it?"
          ]
        },
        {
          "position": 2,
          "text": [
            "Did we",
            "agree to this",
            "as a team?"
          ]
        },
        {
          "position": 3,
          "text": [
            "I can't find",
            "that story in",
            "the backlog!"
          ]
        }
      ]
    },
    {
      "image": "thought1",
      "captions": [
        {
          "position": 3,
          "text": [
            "Me",
            "(Bewildered)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "Sigh! I shouldn't",
            "but fuck it..."
          ]
        }
      ]
    },
    {
      "image": "burst1",
      "captions": [
        {
          "position": 1,
          "text": [
            "2 hours later"
          ]
        },
        {
          "position": 3,
          "text": [
            "Me to team",
            "(DEFCON 2)"
          ]
        },
        {
          "position": 4,
          "text": [
            "Team to me",
            "(Contrary)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "Countless",
            "back-and-forths",
            "defending some",
            "inane industry-standard",
            "thing to people, because...",
            "arrrrggghh",
            "what the living",
            "fuck!"
          ]
        }
      ]
    },
    {
      "image": "speech1",
      "captions": [
        {
          "position": 1,
          "text": [
            "Still in the 15",
            "minute standup..."
          ]
        },
        {
          "position": 3,
          "text": [
            "Team",
            "(Conceited)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "We should setup",
            "a meeting",
            "to discuss further."
          ]
        }
      ]
    },
    {
      "image": "thought1",
      "captions": [
        {
          "position": 3,
          "text": [
            "Me",
            "(Dying on sword)"
          ]
        }
      ],
      "bubbles": [
        {
          "position": 1,
          "text": [
            "When",
            "will I",
            "ever",
            "learn!"
          ]
        }
      ]
    }
  ]
}`;
const input = JSON.parse(json);

var imageURLs = prepareImages(input);
var imgs=[];
var imagesOK=0;
loadImages(prepareAndDraw);

  function prepareImages(i) {
    let r = [];
    for (p of i.panels) {
      r.push('https://canvas.resurnate.com/img/'+p.image+'.png');
    }
    return r;
  }

function loadImages(callback) {

  // iterate through the imageURLs array and create new images for each
  for (var i=0; i<imageURLs.length; i++) {
    // create a new image an push it into the imgs[] array
    var img = new Image();
    // Important! By pushing (saving) this img into imgs[],
    //     we make sure the img variable is free to
    //     take on the next value in the loop.
    imgs.push(img);
    // when this image loads, call this img.onload
    img.onload = function(){ 
      // this img loaded, increment the image counter
      imagesOK++; 
      // if we've loaded all images, call the callback
      if (imagesOK>=imageURLs.length ) {
        callback();
      }
    };
    // notify if there's an error
    img.onerror=function(){alert("image load failed");} 
    // set img properties
    img.src = imageURLs[i];
  }      
}

  function prepareAndDraw() {

    // Prepare and draw canvas
    let c = prepareCanvas();
    drawCanvas(c);
  
    // Prepare and draw panels
    let ps = preparePanels(c);
    drawPanels(c,ps);

    //
    // Order is important to ensure information
    // and copyright aren't overridden!
    //

    // Draw information
    drawCanvasInformation(c);
    
    // Draw copyright
    drawCanvasCopyright(c);

  }

  function prepareCanvas() {
    let cx = CANVAS_ROWS;
    let cy = Math.ceil(input.panels.length / cx);
    return {
      ce  : CANVAS_ELEMENT,
      cc  : CANVAS_ELEMENT.getContext("2d"),
      cx  : cx,
      cy  : cy,
      cw  : (cx * PANEL_WIDTH) + ((cx - 1) * PANEL_PADDING),
      ch  : (cy * PANEL_HEIGHT) + ((cy - 1) * PANEL_PADDING),
      pp  : PANEL_PADDING,
      pw  : PANEL_WIDTH,
      ph  : PANEL_HEIGHT,
      caw : CAPTION_WIDTH,
      cah : CAPTION_HEIGHT,
      iv  : input.version,
      ii  : input.id,
      it  : input.title,
      ia  : input.author,
      ic  : input.copyright
    };
  }

  function preparePanels(c) {
    let r = [];
    var x = 0;
    var y = 0;
    for (var i = 0; i < input.panels.length; i++) {
      // Upper-left x-coordinate
      if ((i % c.cx) === 0) {
        x = 0;
      } else {
        x += c.pp + c.pw;
      }
      // Upper-left y-coordinate
      if (i > 1) {
        if ((i % c.cx) === 0) {
          y += c.pp + c.ph;
        }
      }
      // Prepare panel
      var p = preparePanel(c,x,y,i);
      r.push(p);
    }
    return r;
  }

  /**
     c  = Canvas
     x  = Panel upper-left corner x-coordinate
     y  = Panel upper-left corner y-coordinate
     ip = Panel input
     ii = Panel input index
   */
  function preparePanel(c,x,y,ii) {
   let ip = input.panels[ii];

    // Panel
    let p = {
      p  : PANEL_PADDING,
      w  : PANEL_WIDTH,
      h  : PANEL_HEIGHT,
      x  : x,
      y  : y,
      i  : imgs[ii],
      bi : ip.image
    };

    // Background
    let bgw = p.w - (p.p * 2);
    let bgh = p.h - (p.p * 2);
    let bgux = p.x + p.p;
    let bguy = p.y + p.p;
    let bg = {
      w  : bgw,
      h  : bgh,
      ux : bgux,       // Upper-left
      uy : bguy,
      lx : bgux + bgw, // Lower-right
      ly : bguy + bgh
    };
    p.bg = bg;

    // Bubbles
    let bbs = [];
    let bbc = Number(ip.image.charAt(ip.image.length - 1));
    for (var bi = 0; bi < bbc; bi++) {
      var bbt = prepareBubble(ip,bi);
      let bb = {
        p  : bi,
        in : ip.image,
        ii : imgs[ii],
        t  : bbt
      };
      bbs.push(bb);
    }
    p.bbi = ip.image;
    p.bbs = bbs;

    // Captions
    let cts = [];
    for (var cti = 0; cti < 4; cti++) {
      let ctw = CAPTION_WIDTH;
      let cth = CAPTION_HEIGHT;
      var ctx = p.x;
      var cty = p.y;
      var ctc = "#FFFFFF";
      var ctf = "27px Comic Sans MS";
      var ctt = [];
      if (cti === 0) {        // Upper-left
        ctx = p.x;
        cty = p.y;
        ctc = "#FFFF88";
        ctf = 'italic bold '+ctf;
        ctt = prepareCaption(ip,cti);
      } else if (cti === 1) { // Upper-right
        ctx = p.x + p.p + ctw;
        cty = p.y;
        ctc = "#FFFFCC";
        ctf = 'italic bold '+ctf;
        ctt = prepareCaption(ip,cti);
      } else if (cti === 2) { // Lower-left
        ctx = p.x;
        cty = p.y + p.h - cth;
        ctc = "#CCE5FF";
        ctt = prepareCaption(ip,cti);
      } else {                // Lower-right
        ctx = p.x + p.p + ctw;
        cty = p.y + p.h - cth;
        ctc = "#DAE8FC";
        ctt = prepareCaption(ip,cti);
      }
      let ct = {
        w : ctw,
        h : cth,
        x : ctx,
        y : cty,
        c : ctc,
        f : ctf,
        t : ctt
      };
      cts.push(ct);
    }
    p.cts = cts;

    return p;
  }

  function prepareBubble(i,bi) {
    return prepareBubbleText(i,bi);
  }

  function prepareBubbleText(i,bi) {
    let r = [];
    for (ib of i.bubbles) {
      if ((ib.position - 1) === bi) {
        for (ibt of ib.text) {
          let lt = ibt;
          let lc = "black";
          let lf = "30px Comic Sans MS";
          let la = "center";
          let l = {
            t : lt,
            c : lc,
            f : lf,
            a : la
          };
          r.push(l);
        }
        break;
      }
    }
    return r;
  }

  function prepareCaption(i,ci) {
    return prepareCaptionText(i,ci);
  }

  function prepareCaptionText(i,ci) {
    let r = [];
    for (ic of i.captions) {
      if ((ic.position - 1) === ci) {
        for (var ti = 0; ti < ic.text.length; ti++) {
          let lt = ic.text[ti];
          let lc = "black";
          var lf = "27px Comic Sans MS";
          let la = "center";
          if (ic.position < 3) {
            lf = 'italic bold '+lf;
          } else if (ti > 0) {
            lf = 'italic '+lf;
          }
          let l = {
            t : lt,
            c : lc,
            f : lf,
            a : la
          };
          r.push(l);
        }
        break;
      }
    }
    return r;
  }

  function drawCanvas(c) {
    c.ce.width = c.cw;
    c.ce.height = c.ch;
  }

  function drawCanvasInformation(c) {
    c.cc.save();
    c.cc.translate((c.cw / 2), ((c.ph / 2) + c.ph));
    c.cc.rotate((3 * Math.PI) / 2);
    c.cc.fillStyle = "black";
    c.cc.font = "14px Helvetica";
    c.cc.textAlign = "center";
    let t = c.ii+' "'+c.it+'" by '+c.ia;
    c.cc.fillText(t.toUpperCase(), 0, 5);
    c.cc.restore();
  }
  
  function drawCanvasCopyright(c) {
    c.cc.save();
    c.cc.translate((c.cw / 2), (c.ph / 2));
    c.cc.rotate((3 * Math.PI) / 2);
    c.cc.fillStyle = "black";
    c.cc.font = "14px Helvetica";
    c.cc.textAlign = "center";
    let t = c.ic;
    c.cc.fillText('\u00A9'+' '+t.toUpperCase(), 0, 5);
    c.cc.restore();
  }

  function drawPanels(c,ps) {
    for (var pi = 0; pi < ps.length; pi++) {
      let p = ps[pi];
      drawPanel(c,p);
    }
  }

  function drawPanel(c,p) {
    drawPanelBackground(c,p);
    if (p.bbi.startsWith("burst")) {
      // Bubble on top of captions - bursting!
      drawPanelCaptions(c,p);
      drawPanelBubbles(c,p);
    } else {
      drawPanelBubbles(c,p);
      drawPanelCaptions(c,p);
    }
  }

  function drawPanelBackground(c,p) {

    // Background
    let g = c.cc.createLinearGradient(p.bg.ux, p.bg.uy, p.bg.ux, p.bg.ly);
    g.addColorStop(0, "#B3B3B3");
    g.addColorStop(1, "#F7F7F7");
    c.cc.strokeStyle = "#666666";
    
    // Draw
    c.cc.fillStyle = g;
    c.cc.fillRect(p.bg.ux,p.bg.uy,p.bg.w,p.bg.h);
    c.cc.strokeRect(p.bg.ux,p.bg.uy,p.bg.w,p.bg.h);

  }

  function drawPanelBubbles(c,p) {
    for (var bi = 0; bi < p.bbs.length; bi++) {
      var b = p.bbs[bi];
      // Offset
      var o;
      for (var bo of BUBBLE_OFFSETS) {
        if (bo.l === b.in) {
          o = bo;
          break;
        }
      }
      // Draw
      drawPanelBubble(c,p,o,bi);
    }
  }

  function drawPanelBubble(c,p,o,i) {

    // Draw image (once)
    if (i === 0) {
      drawPanelBubbleImage(c,p,o);
    }

    // Draw text
    drawPanelBubbleText(c,p,o,i);

  }

  function drawPanelBubbleImage(c,p,o) {

    // Offset
    let io = o.i;
    let iw = p.bg.w + io.w;
    var ih = p.bg.h + io.h;
    let ix = p.bg.ux + io.x;
    let iy = p.bg.uy + io.y;

    // Draw
    c.cc.drawImage(p.i, ix, iy, iw, ih);

  }
  
  function drawPanelBubbleText(c,p,o,i) {

    // Offset
    let io = o.i;
    let iw = p.bg.w + io.w;
    var ih = p.bg.h + io.h;
    let ix = p.bg.ux + io.x;
    let iy = p.bg.uy + io.y;
    let to = o.t[i];
    let tls = p.bbs[i].t;
    let tf = 30;
    let tx = ix + (iw / 2) + to.x;
    var ty = iy + (ih / 2) + to.y;
    ty = ty - (Math.floor(tls.length / 2) * tf);
    
    // Draw
    let t = {
      x  : tx,
      y  : ty,
      c  : "black",
      f  : "30px Comic Sans MS",
      a  : "center",
      s  : tf,
      ls : tls
    };
    drawPanelText(c,t);

  }

  function drawPanelCaptions(c,p) {
    for (var i = 0; i < p.cts.length; i++) {
      let ct = p.cts[i];
      if (ct.t.length > 0) {
        drawPanelCaption(c,p,ct);
      }
    }
  }

  function drawPanelCaption(c,p,ct) {

    // Draw box
    drawPanelCaptionBox(c,ct);

    // Draw text
    drawPanelCaptionText(c,ct);

  }

  function drawPanelCaptionBox(c,ca) {
    c.cc.fillStyle = ca.c;
    c.cc.fillRect(ca.x,ca.y,ca.w,ca.h);
    c.cc.strokeStyle = "#666666";
    c.cc.strokeRect(ca.x,ca.y,ca.w,ca.h);
  }

  function drawPanelCaptionText(c,ct) {
  
    // Offset
    let to = -3;                // Offset percentage
    let tf = 27;                // Font size
    let tx = ct.x + (ct.w / 2); // Start x-coordinate
    var ty = ct.y + ((ct.h) / 2) + (ct.h * to / 100); // Start y-coordinate
    ty = ty - (Math.floor(ct.t.length / 2) * tf) + Math.floor(tf / 2);

    // Draw text lines
    let t = {
      x  : tx,
      y  : ty,
      s  : tf,
      ls : ct.t
    };
    drawPanelText(c,t);

  }

  /**
   * Draw text lines in bubble or caption, where:
   *  - c : canvas
   *  - t : text
   */
  function drawPanelText(c,t) {
    let x = t.x;
    var y = t.y;
    if ((t.ls.length % 2) === 0) { y += (t.s / 2); } // Recenter
    for (l of t.ls) {
      drawPanelTextLine(c,l,x,y);
      y += t.s;
    }
  }

  /**
   *  Draw text line in bubble or caption, where:
   *   - c : canvas
   *   - l : line
   *   - x : x-coordinate (relative to canvas)
   *   - y : y-coordinate (relative to canvas)
   */
  function drawPanelTextLine(c,l,x,y) {
    c.cc.fillStyle = l.c;
    c.cc.font = l.f;
    c.cc.textAlign = l.a;
    c.cc.fillText(l.t.toUpperCase(), x, y);
  }

</script>

</body>
</html>

