<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Resurnate Canvas</title>
  <script type="text/javascript" src="/js/canvas.js"></script>
  <style>

    input[type=text] {
      width: 100%;
      /*padding: 5%;*/
    }

    textarea {
      width: 100%;
    }

    .split {
      height: 100%;
      position: fixed;
      top: 0;
      overflow-x: hidden;
      padding-top: 20px;
    }

    .left {
      width: 25%;
      left: 0;
      background-color: #41b6e6;
    }

    .right {
      width: 75%;
      right: 0;
      background-color: #ffffff;
      /*margin-left: 10px;*/
    }

    .centered {
      /*position: absolute;*/
      /*top: 50%;*/
      /*left: 50%;*/
      /*transform: translate(-50%, -50%);*/
      text-align: center;
    }

    .centered canvas {
      width: 65%;
    }

    .button {
      background-color: #003087;
      border: none;
      color: white;
      padding: 10px;
      text-align: center;
      text-decoration: none;
      font-size: 16px;
      font-weight: bold;
      margin: 4px 2px;
      cursor: pointer;
      /*width: 90px;*/
      /*height: 35px;*/
    }

  </style>
</head>
<body onload="preparePage();">


<div class="split left">
  <div class="centered">
    <div style="margin-left: 5px; margin-right: 15px">
      <h2>Resurnate Canvas</h2>
      <h3 style="text-align: left">Server</h3>
      <input id="server" type="text" name="server" value="https://canvas.resurnate.com">
      <h3 style="text-align: left">File</h3>
      <input id="url" type="text" name="url" value="https://canvas.resurnate.com/doc/sample.json">
      <p>
        <input class="button" type="button" value="LOAD" onclick="loadJson()">
        <input class="button" type="button" value="PREVIEW" onclick="generate()">
        <input class="button" type="button" value="RESET" onclick="reset()">
      </p>
      <h3 style="text-align: left">Content</h3>
      <textarea id="textarea" name="textarea" placeholder="Copy and paste your strip JSON formatted content here!" rows="50"></textarea>
    </div>
  </div>
</div>


<div class="split right">
  <div class="centered">
    <h2 id="preview">LOAD then click PREVIEW</h2>
    <div id="blahblah"></div>
  </div>
</div>

<script>

  function preparePage() {
    // var viewportHeight = window.height();
    // let url = document.getElementById("url");
    let textarea = document.getElementById("textarea");
    textarea.rows = 100;
  }

  // const CANVAS_ELEMENT = document.getElementById("canvas");
// XXX: This should be read in from a v1 file appropriately!
  const BUBBLE_OFFSETS = [
    {
      l : "speech1",
      i : { w : 0, h : -150, x : 0, y : 100 },
      t : [
        { x : 0, y : -15 }
      ]
    },
    {
      l : "speech3",
      i : { w : -20, h : -180, x : 12, y : 100 },
      t : [
        { x : 135, y : -110 },
        { x : -140, y : -49 },
        { x : -8, y : 110 }
      ]
    },
    {
      l : "thought1",
      i : { w : -25, h : -120, x : 10, y : 110 },
      t : [
        { x : 0, y : -40 }
      ]
    },
    {
      l : "burst1",
      i : { w : 20, h : -140, x : -10, y : 70 },
      t : [
        { x : 0, y : 10 }
      ]
    }
  ];

  var input;
  var imageURLs = [];
  var imgs = [];
  var imagesOK = 0;

  function loadJson() {
    let url = document.getElementById("url");
    fetchJson(url.value)
      .then((result) => {
        let textarea = document.getElementById("textarea");
        textarea.value = result;
        textarea.rows = 50;
      })
      .catch((err) => {
        alert("Failed to load JSON file");
      });
  }
              
  function fetchJson(url) {
    return new Promise(function (resolve, reject) {
      let xhr = new XMLHttpRequest();
      xhr.addEventListener("readystatechange", () => {
        if (xhr.readyState === 4 && xhr.status === 200) {
          let result = xhr.responseText;
          resolve(result);
        } else if (xhr.readyState === 4) {
          reject(oopsMessage);
        }
      });
      xhr.open('GET', url);
      xhr.send();
    });
  }

  function generate() {
    let preview = document.getElementById("preview");
    preview.innerHTML = "Generating strip preview...";
    // let canvas = document.getElementById("canvas");
    // let ctx = canvas.getContext("2d")
    // ctx.clearRect(0, 0, canvas.width, canvas.height);
    let textarea = document.getElementById("textarea");
    let json = textarea.value;
    input = JSON.parse(json);
    imageURLs = prepareImages(input);
    loadImages(prepareAndDrawCanvas);
    preview.innerHTML = "Strip Preview"

  }

  function prepareImages(i) {
    let r = [];
    let server = document.getElementById("server");
    let url = server.value;
    imageUrls = [];
    imgs = [];
    imagesOK = 0;
    for (p of i.panels) {
      r.push(url+'/img/'+p.image+'.png');
    }
    return r;
  }

  function loadImages(callback) {
    var a = true;
    for (var i = 0; i < imageURLs.length; i++) {
      let img = new Image();
      imgs.push(img);
      img.onload = function() { 
        imagesOK++; 
        if (imagesOK >= imageURLs.length) {
          callback();
        }
      };
      img.onerror=function() {
        if (a) {
          alert("Failed to load image: " + imageURLs[i]);
          a = false;
        }
      }
      img.src = imageURLs[i];
    }
  }

  function prepareAndDrawCanvas() {

    // Prepare and draw canvas
    let c = prepareCanvas();
    drawCanvas(c);
  
    // Prepare and draw panels
    let ps = preparePanels(c);
    drawPanels(c,ps);

    //
    // Order is important to ensure information
    // and copyright aren't overridden!
    //

    // Draw information
    drawCanvasInformation(c);
    
    // Draw copyright
    drawCanvasCopyright(c);

  }

  function prepareCanvas() {
    let cx = CANVAS_ROWS;
    let cy = Math.ceil(input.panels.length / cx);
    let cw = (cx * PANEL_WIDTH) + ((cx - 1) * PANEL_PADDING);
    let ch = (cy * PANEL_HEIGHT) + ((cy - 1) * PANEL_PADDING);

    let canvas = document.createElement('canvas');
    canvas.id     = "canvas";
    canvas.width  = cw;
    canvas.height = ch;


    canvas.onwheel =function(){
      window.addEventListener('DOMMouseScroll', wheel, true);
    }


    let ctx = canvas.getContext("2d");
    // let scale = 0.50;
    // ctx.scale(scale,scale);

    let blahblah = document.getElementById("blahblah");
    blahblah.appendChild(canvas);




    // canvas.style.zIndex   = 8;
    // canvas.style.position = "absolute";
    // canvas.style.border   = "1px solid";


    return {
      ce  : canvas, // CANVAS_ELEMENT,
      cc  : ctx, // canvas.getContext("2d"), // CANVAS_ELEMENT.getContext("2d"),
      cx  : cx,
      cy  : cy,
      cw  : cw, // (cx * PANEL_WIDTH) + ((cx - 1) * PANEL_PADDING),
      ch  : ch, // (cy * PANEL_HEIGHT) + ((cy - 1) * PANEL_PADDING),
      pp  : PANEL_PADDING,
      pw  : PANEL_WIDTH,
      ph  : PANEL_HEIGHT,
      caw : CAPTION_WIDTH,
      cah : CAPTION_HEIGHT,
      iv  : input.version,
      ii  : input.id,
      it  : input.title,
      ia  : input.author,
      ic  : input.copyright
    };
  }

  function preparePanels(c) {
    let r = [];
    var x = 0;
    var y = 0;
    for (var i = 0; i < input.panels.length; i++) {
      // Upper-left x-coordinate
      if ((i % c.cx) === 0) {
        x = 0;
      } else {
        x += c.pp + c.pw;
      }
      // Upper-left y-coordinate
      if (i > 1) {
        if ((i % c.cx) === 0) {
          y += c.pp + c.ph;
        }
      }
      // Prepare panel
      var p = preparePanel(c,x,y,i);
      r.push(p);
    }
    return r;
  }

  /**
     c  = Canvas
     x  = Panel upper-left corner x-coordinate
     y  = Panel upper-left corner y-coordinate
     ip = Panel input
     ii = Panel input index
   */
  function preparePanel(c,x,y,ii) {
   let ip = input.panels[ii];

    // Panel
    let p = {
      p  : PANEL_PADDING,
      w  : PANEL_WIDTH,
      h  : PANEL_HEIGHT,
      x  : x,
      y  : y,
      i  : imgs[ii],
      bi : ip.image
    };

    // Background
    let bgw = p.w - (p.p * 2);
    let bgh = p.h - (p.p * 2);
    let bgux = p.x + p.p;
    let bguy = p.y + p.p;
    let bg = {
      w  : bgw,
      h  : bgh,
      ux : bgux,       // Upper-left
      uy : bguy,
      lx : bgux + bgw, // Lower-right
      ly : bguy + bgh
    };
    p.bg = bg;

    // Bubbles
    p.bbi = ip.image;
    p.bbs = preparePanelBubbles(ip,ip.bubbles);

    // Captions
    p.cts = preparePanelCaptions(p,ip.captions);

    return p;
  }

  function drawCanvas(c) {
    c.ce.width = c.cw;
    c.ce.height = c.ch;
  }

  function drawCanvasInformation(c) {
    c.cc.save();
    c.cc.translate((c.cw / 2), ((c.ph / 2) + c.ph));
    c.cc.rotate((3 * Math.PI) / 2);
    c.cc.fillStyle = "black";
    c.cc.font = "14px Helvetica";
    c.cc.textAlign = "center";
    let t = c.ii+' "'+c.it+'" by '+c.ia;
    c.cc.fillText(t.toUpperCase(), 0, 5);
    c.cc.restore();
  }
  
  function drawCanvasCopyright(c) {
    c.cc.save();
    c.cc.translate((c.cw / 2), (c.ph / 2));
    c.cc.rotate((3 * Math.PI) / 2);
    c.cc.fillStyle = "black";
    c.cc.font = "14px Helvetica";
    c.cc.textAlign = "center";
    let t = c.ic;
    c.cc.fillText('\u00A9'+' '+t.toUpperCase(), 0, 5);
    c.cc.restore();
  }

  function drawPanels(c,ps) {
    for (var pi = 0; pi < ps.length; pi++) {
      let p = ps[pi];
      drawPanel(c,p);
    }
  }

  function drawPanel(c,p) {
    drawPanelBackground(c,p);
    if (p.bbi.startsWith("burst")) {
      // Bubble on top of captions - bursting!
      drawPanelCaptions(c,p);
      drawPanelBubbles(c,p);
    } else {
      drawPanelBubbles(c,p);
      drawPanelCaptions(c,p);
    }
  }

  function drawPanelBackground(c,p) {

    // Background
    let g = c.cc.createLinearGradient(p.bg.ux, p.bg.uy, p.bg.ux, p.bg.ly);
    g.addColorStop(0, "#B3B3B3");
    g.addColorStop(1, "#F7F7F7");
    c.cc.strokeStyle = "#666666";
    
    // Draw
    c.cc.fillStyle = g;
    c.cc.fillRect(p.bg.ux,p.bg.uy,p.bg.w,p.bg.h);
    c.cc.strokeRect(p.bg.ux,p.bg.uy,p.bg.w,p.bg.h);

  }

  function drawPanelBubbles(c,p) {
    for (var bi = 0; bi < p.bbs.length; bi++) {
      var b = p.bbs[bi];
      // Offset
      var o;
      for (var bo of BUBBLE_OFFSETS) {
        if (bo.l === b.i.l) {
          o = bo;
          break;
        }
      }
      // Draw
      drawPanelBubble(c,p,o,bi);
    }
  }

  function drawPanelBubble(c,p,o,i) {

    // Draw image (once)
    if (i === 0) {
      drawPanelBubbleImage(c,p,o);
    }

    // Draw text
    drawPanelBubbleText(c,p,o,i);

  }

  function drawPanelBubbleImage(c,p,o) {

    // Offset
    let io = o.i;
    let iw = p.bg.w + io.w;
    var ih = p.bg.h + io.h;
    let ix = p.bg.ux + io.x;
    let iy = p.bg.uy + io.y;

    // Draw
    c.cc.drawImage(p.i, ix, iy, iw, ih);

  }
  
  function drawPanelBubbleText(c,p,o,i) {

    // Offset
    let io = o.i;
    let iw = p.bg.w + io.w;
    var ih = p.bg.h + io.h;
    let ix = p.bg.ux + io.x;
    let iy = p.bg.uy + io.y;
    let to = o.t[i];
    let tls = p.bbs[i].t;
    let tf = 30;
    let tx = ix + (iw / 2) + to.x;
    var ty = iy + (ih / 2) + to.y;
    ty = ty - (Math.floor(tls.length / 2) * tf);
    // Recenter if even number of lines
    if ((tls.length % 2) === 0) { ty += (tf / 2); }
    
    // Draw
    let t = {
      x  : tx,
      y  : ty,
      c  : "black",
      f  : "30px Comic Sans MS",
      a  : "center",
      s  : tf,
      ls : tls
    };
    drawPanelText(c,t);

  }

</script>

</body>
</html>
